<!-- ... (head and styles unchanged) -->
</head>
<body>

<!-- 1️⃣ Landing (unchanged) -->
<section id="landing" class="center" style="height:100%;">
  <h1>Terra</h1>
  <button onclick="show('login')">Login</button>
  <button onclick="show('register')">Register</button>
</section>

<!-- 2️⃣ Register (unchanged except validation already added) -->
<section id="register" class="card hidden">
  <h2>Create account</h2>
  <input id="reg-email" type="email"    placeholder="Email">
  <input id="reg-pass1" type="password" placeholder="Password">
  <input id="reg-pass2" type="password" placeholder="Confirm password">
  <div id="reg-err" class="error"></div>
  <button onclick="register()">Register</button>
  <pre id="reg-res"></pre>
  <p style="text-align:center;margin-top:1rem;">Have an account?
     <a href="#" onclick="show('login');return false;">Log in</a></p>
</section>

<!-- 3️⃣ Login (unchanged) -->
<section id="login" class="card hidden">
  <h2>Welcome back</h2>
  <input id="log-email" type="email"    placeholder="Email">
  <input id="log-pass"  type="password" placeholder="Password">
  <div id="log-err" class="error"></div>
  <button onclick="login()">Login</button>
  <pre id="log-res"></pre>
  <p style="text-align:center;margin-top:1rem;">Need an account?
     <a href="#" onclick="show('register');return false;">Register</a></p>
</section>

<!-- 4️⃣ Calculator w/ dropdown support -->
<section id="calc" class="card hidden">
  <h2>Calculator (saved)</h2>

  <!-- Scenario name input -->
  <input id="scenario-name" placeholder="Scenario name">

  <!-- Number inputs -->
  <input id="a" type="number" placeholder="Number a">
  <input id="b" type="number" placeholder="Number b">

  <!-- Save button -->
  <button onclick="saveAndCalc()">Save & Calculate</button>
  <pre id="calc-res"></pre>

  <!-- ✅ ADDED: Dropdown + load -->
  <h3 style="margin-top:1.3rem;">Saved scenarios</h3>

  <!-- Dropdown to select saved scenario -->
  <select id="scenario-list" style="width:100%;">
    <option value="">-- Select a saved scenario --</option>
  </select>

  <!-- Load button -->
  <button onclick="loadScenario()">Load</button>

  <!-- Logout -->
  <p style="text-align:center;margin-top:1rem;">
     <a href="#" onclick="logout();return false;">Log out</a></p>
</section>

<script>
/* ========= State =========== */
let token = null;

/* ========= Regex: Password must be strong ========== */
const pwdRx = /^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/;

/* ========= Panel display ========== */
const panels = ['landing','login','register','calc'];
function show(id){
  panels.forEach(p => document.getElementById(p).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

/* ========= REGISTER ========= */
async function register(){
  const em = document.getElementById('reg-email').value.trim();
  const p1 = document.getElementById('reg-pass1').value;
  const p2 = document.getElementById('reg-pass2').value;
  const err = document.getElementById('reg-err');
  err.textContent = '';

  if (!em || !p1 || !p2) {
    err.textContent = 'All fields required'; return;
  }
  if (p1 !== p2) {
    err.textContent = 'Passwords do not match'; return;
  }
  if (!pwdRx.test(p1)) {
    err.textContent = 'Weak password (≥8 chars, 1 cap, 1 number, 1 symbol)'; return;
  }

  const res = await fetch('/register', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ email: em, password: p1 })
  });

  document.getElementById('reg-res').textContent = await res.text();
  if (res.ok) {
    show('login');
    document.getElementById('log-email').value = em;
  }
}

/* ========= LOGIN ========= */
async function login(){
  const em = document.getElementById('log-email').value.trim();
  const pw = document.getElementById('log-pass').value;
  const err = document.getElementById('log-err');
  err.textContent = '';

  if (!em || !pw) {
    err.textContent = 'Email & password required'; return;
  }

  const r = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: em, password: pw })
  });

  const data = await r.json();

  if (r.ok && data.token) {
    token = data.token;
    show('calc');
    refreshList(); // ✅ ADDED: refresh list on login
  } else {
    err.textContent = data.error || 'Login failed';
  }
}

/* ========= SAVE + CALCULATE ========= */
async function saveAndCalc(){
  if (!token) { alert('Login first'); return; }

  const name = document.getElementById('scenario-name').value.trim() || 'Untitled';
  const a = parseFloat(document.getElementById('a').value);
  const b = parseFloat(document.getElementById('b').value);

  const r = await fetch('/api/calculate', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ name, a, b })
  });

  const data = await r.json();
  document.getElementById('calc-res').textContent = JSON.stringify(data, null, 2);

  if (r.ok) refreshList(); // ✅ ADDED: update list after saving
}

/* ========= SCENARIO: Refresh Dropdown ========= */
async function refreshList(){
  const r = await fetch('/api/scenarios', {
    headers: { 'Authorization': 'Bearer ' + token }
  });

  if (!r.ok) {
    console.error("Dropdown fetch failed:", await r.text());
    return;
  }

  const list = await r.json(); // [{id, name, a, b}, …]
  const sel = document.getElementById('scenario-list');
  sel.innerHTML = '<option value="">-- Select a saved scenario --</option>'; // ✅ Default option

  list.forEach(sc => {
    const opt = document.createElement('option');
    opt.value = JSON.stringify(sc); // store whole object
    opt.textContent = `${sc.name} (a=${sc.a}, b=${sc.b})`;
    sel.appendChild(opt);
  });
}

/* ========= Load a saved scenario ========= */
function loadScenario(){
  const sel = document.getElementById('scenario-list');
  if (!sel.value) {
    alert('Choose a scenario'); return;
  }

  const sc = JSON.parse(sel.value);
  document.getElementById('scenario-name').value = sc.name;
  document.getElementById('a').value = sc.a;
  document.getElementById('b').value = sc.b;
  document.getElementById('calc-res').textContent = `Loaded scenario #${sc.id}`;
}

/* ========= LOGOUT ========= */
function logout(){
  token = null;
  show('landing');
}
</script>
</body>
</html>
